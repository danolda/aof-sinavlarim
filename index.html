<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AÖF Sınav Robotu (Final v3)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .question-img { 
            max-width: 100%; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            margin: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-height: 100px;
            background-color: #f8f9fa;
        }
        
        .btn-circle { 
            width: 45px; height: 45px; border-radius: 50%; padding: 0; 
            font-weight: bold; margin: 5px; border: 2px solid #495057;
            color: #495057; background: white; transition: all 0.2s;
        }
        .btn-circle:hover { background-color: #495057; color: white; }
        
        .correct-green { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
        .wrong-red { background-color: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .log-text { font-size: 0.85rem; color: #6c757d; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container py-5">
    
    <!-- AYARLAR -->
    <div id="setup-panel" class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-4">
                <div class="text-center mb-4">
                    <h2 class="fw-bold text-primary">AÖF Sınav Çözücü</h2>
                    <p class="text-muted">Gelişmiş resim ve cevap analizi.</p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold">Ders Linki</label>
                    <input type="text" class="form-control mb-2 url-input" placeholder="https://aofsoru.com/..." >
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Kaç Yıl?</label>
                        <select id="yearLimit" class="form-select">
                            <option value="4" selected>Son 4 Yıl</option>
                            <option value="10">Tümü</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Sınav Türü</label>
                        <select id="examType" class="form-select">
                            <option value="vize">Ara Sınav (Vize)</option>
                            <option value="final">Dönem Sonu (Final)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary w-100 btn-lg mt-4" onclick="startProcess()">
                    Soruları Getir
                </button>
            </div>
        </div>
    </div>

    <!-- DERS LİSTESİ -->
    <div id="course-panel" class="hidden">
        <h3 class="text-center mb-4">Hazırlanan Sınavlar</h3>
        <div id="course-list" class="d-grid gap-3"></div>
        <button class="btn btn-outline-secondary mt-4 w-100" onclick="location.reload()">Başa Dön</button>
    </div>

    <!-- SINAV EKRANI -->
    <div id="quiz-panel" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3 sticky-top bg-white p-3 shadow-sm rounded">
            <h5 id="currentCourseTitle" class="m-0 text-truncate">Ders Adı</h5>
            <button class="btn btn-sm btn-danger" onclick="switchPanel('course-panel')">Kapat</button>
        </div>
        <div id="questions-container" class="col-lg-8 mx-auto"></div>
        <button class="btn btn-success w-100 mt-4 mb-5" onclick="switchPanel('course-panel')">Sınavı Bitir</button>
    </div>

</div>

<!-- YÜKLENİYOR -->
<div id="loading" class="loading-overlay hidden">
    <div class="spinner-border text-primary" role="status"></div>
    <h5 class="mt-3">Veriler İşleniyor...</h5>
    <p id="loadingLog" class="log-text">Sunucuya bağlanılıyor...</p>
</div>

<script>
    const BASE_URL = "https://aofsoru.com";
    let examData = [];

    // Proxy Listesi
    const PROXIES = [
        { url: "https://api.codetabs.com/v1/proxy?quest=", type: "text" }, 
        { url: "https://api.allorigins.win/get?url=", type: "json" },
        { url: "https://corsproxy.io/?", type: "text" }
    ];

    async function fetchWithFallback(targetUrl) {
        for (let i = 0; i < PROXIES.length; i++) {
            const proxy = PROXIES[i];
            const fullUrl = proxy.url + encodeURIComponent(targetUrl);
            updateLog(`Proxy deneniyor (${i+1}/${PROXIES.length})...`);
            
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) throw new Error("Proxy hatası");

                let htmlContent = "";
                if (proxy.type === "json") {
                    const data = await response.json();
                    htmlContent = data.contents;
                } else {
                    htmlContent = await response.text();
                }

                if (!htmlContent || htmlContent.length < 500) throw new Error("Eksik veri");
                
                console.log(`Veri alındı: ${proxy.url}`);
                return htmlContent;

            } catch (error) {
                console.warn(`Proxy ${i+1} başarısız.`);
            }
        }
        return null;
    }

    function parseHtml(htmlString) {
        return new DOMParser().parseFromString(htmlString, "text/html");
    }

    async function startProcess() {
        const inputs = document.querySelectorAll('.url-input');
        const urls = Array.from(inputs).map(i => i.value.trim()).filter(v => v !== "");
        const yearLimit = parseInt(document.getElementById('yearLimit').value);
        const examType = document.getElementById('examType').value;

        if (urls.length === 0) { alert("Lütfen link girin."); return; }

        showLoading(true);
        examData = [];

        for (let url of urls) {
            if (!url.startsWith('http')) url = 'https://' + url;

            updateLog("Ders sayfası analiz ediliyor...");
            const courseHtml = await fetchWithFallback(url);
            
            if (!courseHtml) {
                alert(`Hata: Siteye erişilemedi. Lütfen daha sonra tekrar deneyin.`);
                continue;
            }

            const doc = parseHtml(courseHtml);
            let title = doc.querySelector('h1')?.innerText.replace('Soruları', '').trim() || "Ders";
            
            updateLog(`${title} sınavları aranıyor...`);
            const links = getExamLinks(doc, examType, yearLimit);

            if (links.length > 0) {
                updateLog(`${links.length} sınav bulundu. Sorular çekiliyor...`);
                const questions = await scrapeQuestionsFromLinks(links);
                if (questions.length > 0) {
                    examData.push({ title, questions });
                }
            }
        }

        showLoading(false);
        if (examData.length > 0) {
            renderCourses();
            switchPanel('course-panel');
        } else {
            alert("Hiçbir soru çekilemedi. Linkleri kontrol edin.");
        }
    }

    function getExamLinks(doc, type, limit) {
        const targetText = type === "vize" ? "ARA" : "DÖNEM SONU";
        let validLinks = [];
        
        doc.querySelectorAll('a').forEach(link => {
            const title = (link.getAttribute('title') || "").toUpperCase();
            const href = link.getAttribute('href');
            
            if (title.includes(targetText) && href) {
                const yearMatch = title.match(/(\d{4})\s*-\s*(\d{4})/);
                let year = yearMatch ? parseInt(yearMatch[1]) : 0;
                let fullUrl = href.startsWith('http') ? href : BASE_URL + (href.startsWith('/') ? '' : '/') + href;
                validLinks.push({ url: fullUrl, year, title });
            }
        });
        return validLinks.sort((a, b) => b.year - a.year).slice(0, limit);
    }

    // --- EN ÖNEMLİ KISIM: SORU VE CEVAP ÇEKME GÜNCELLEMESİ ---
    async function scrapeQuestionsFromLinks(links) {
        let allQuestions = [];
        for (let link of links) {
            updateLog(`İşleniyor: ${link.title}`);
            await new Promise(r => setTimeout(r, 1000)); 
            
            const html = await fetchWithFallback(link.url);
            if (!html) continue;

            const doc = parseHtml(html);
            const imgs = doc.querySelectorAll('img.QuestionImg');

            imgs.forEach(img => {
                // 1. ÖNCE data-src KONTROL ET (Gerçek resim burada)
                let src = img.getAttribute('data-src');
                
                // 2. data-src yoksa src'ye bak
                if (!src) src = img.getAttribute('src');

                if (src) {
                    // URL DÜZELTME
                    src = src.trim();
                    if (src.startsWith('//')) {
                        src = 'https:' + src;
                    } else if (src.startsWith('/')) {
                        // Eğer başında / varsa ana domaini ekle
                        src = 'https://image.aofsoru.com' + src; 
                        // Not: Site bazen image.aofsoru.com bazen aofsoru.com kullanıyor.
                        // Garanti olsun diye resim sunucusunu ekledik. Resim açılmazsa aofsoru.com deneriz.
                        if(src.includes('undefined')) src = BASE_URL + img.getAttribute('src');
                    }

                    // CEVAP BULMA MANTIĞI (Genişletilmiş)
                    let answer = "Bilinmiyor";
                    
                    // Resmin olduğu en yakın kartı (kutuyu) bul
                    let card = img.closest('.card') || img.closest('.card-body') || img.parentElement.parentElement;
                    
                    if (card) {
                        // O kartın içindeki yeşil butonu (doğru cevap) ara
                        const btn = card.querySelector('.btn-success');
                        if (btn) {
                            answer = btn.innerText.trim().replace(/[^A-E]/g, ''); // Sadece A,B,C,D,E harfini al
                        }
                    }

                    allQuestions.push({
                        image: src,
                        answer: answer,
                        info: link.title
                    });
                }
            });
        }
        return allQuestions;
    }

    // --- UI ---
    function renderCourses() {
        const list = document.getElementById('course-list');
        list.innerHTML = "";
        examData.forEach((course, index) => {
            list.innerHTML += `
                <div class="card p-3 shadow-sm" onclick="startQuiz(${index})" style="cursor:pointer; border-left:5px solid #0d6efd">
                    <h5 class="m-0">${course.title}</h5>
                    <small class="text-muted">${course.questions.length} Soru</small>
                </div>`;
        });
    }

    function startQuiz(index) {
        const course = examData[index];
        document.getElementById('currentCourseTitle').innerText = course.title;
        const container = document.getElementById('questions-container');
        container.innerHTML = "";

        course.questions.forEach((q, i) => {
            container.innerHTML += `
                <div class="card mb-4">
                    <div class="card-header bg-white text-muted small">${q.info} - Soru ${i+1}</div>
                    <div class="card-body text-center">
                        <img src="${q.image}" class="question-img" 
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/600x200?text=Resim+Yuklenemedi';">
                        
                        <div class="mt-3" id="opts-${i}">
                            ${['A','B','C','D','E'].map(opt => 
                                `<button class="btn btn-circle" onclick="check(this, '${opt}', '${q.answer}', ${i})">${opt}</button>`
                            ).join('')}
                        </div>
                        <div id="fb-${i}" class="mt-2 fw-bold" style="min-height:24px"></div>
                    </div>
                </div>`;
        });
        switchPanel('quiz-panel');
    }

    window.check = function(btn, selected, correct, id) {
        const parent = document.getElementById(`opts-${id}`);
        const fb = document.getElementById(`fb-${id}`);
        parent.querySelectorAll('button').forEach(b => b.disabled = true);

        if (!correct || correct === "Bilinmiyor" || correct === "") {
            fb.innerHTML = "<span class='text-warning'>Cevap sistemde bulunamadı.</span>";
            return;
        }

        if (selected === correct) {
            btn.classList.add('correct-green');
            fb.innerHTML = "<span class='text-success'>Doğru!</span>";
        } else {
            btn.classList.add('wrong-red');
            fb.innerHTML = `<span class='text-danger'>Yanlış. Cevap: ${correct}</span>`;
            
            // Doğru şıkkı bul ve yeşil yap
            let found = false;
            Array.from(parent.children).forEach(b => {
                if(b.innerText.trim() === correct) {
                    b.classList.add('correct-green');
                    found = true;
                }
            });
        }
    }

    function switchPanel(id) {
        ['setup-panel','course-panel','quiz-panel'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function updateLog(msg) {
        document.getElementById('loadingLog').innerText = msg;
    }
</script>

</body>
</html>
