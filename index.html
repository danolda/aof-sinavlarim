<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AÖF Sınav Robotu (V5 - Deep Scan)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        
        .card { border: none; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow: hidden; }
        .question-img { 
            max-width: 100%; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            margin: 15px 0;
            background-color: #fff;
        }
        
        /* Şık Butonları */
        .btn-circle { 
            width: 55px; height: 55px; border-radius: 50%; padding: 0; 
            font-size: 1.3rem; font-weight: bold; margin: 0 10px; 
            border: 2px solid #adb5bd; color: #495057; background: white; 
            transition: all 0.2s;
        }
        .btn-circle:hover { background-color: #495057; color: white; transform: scale(1.1); }
        .btn-circle:disabled { opacity: 1; } /* Cevap göründüğünde soluklaşmasın */

        /* Cevap Renkleri */
        .correct-green { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
        .wrong-red { background-color: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .log-text { font-size: 0.9rem; color: #6c757d; margin-top: 10px; font-family: monospace; }
        
        .year-badge { position: absolute; top: 10px; right: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container py-5">
    
    <!-- 1. AYAR PANELİ -->
    <div id="setup-panel" class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-5">
                <div class="text-center mb-5">
                    <h2 class="fw-bold text-primary">AÖF Sınav Robotu V5</h2>
                    <p class="text-muted">Gelişmiş yıl filtreleme ve derin script analizi.</p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold">Ders Linki</label>
                    <input type="text" class="form-control form-control-lg url-input" placeholder="https://aofsoru.com/..." >
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Dönem Sayısı</label>
                        <select id="yearLimit" class="form-select form-select-lg">
                            <option value="3">Son 3 Sınav</option>
                            <option value="4" selected>Son 4 Sınav</option>
                            <option value="5">Son 5 Sınav</option>
                            <option value="10">Tümü</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Sınav Türü</label>
                        <select id="examType" class="form-select form-select-lg">
                            <option value="vize">Ara Sınav (Vize)</option>
                            <option value="final">Dönem Sonu (Final)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary w-100 btn-lg mt-5 py-3 fw-bold shadow" onclick="startProcess()">
                    Sınavları Getir
                </button>
            </div>
        </div>
    </div>

    <!-- 2. DERS LİSTESİ -->
    <div id="course-panel" class="hidden">
        <h3 class="text-center mb-4 fw-bold">Bulunan Sınavlar</h3>
        <div id="course-list" class="d-grid gap-3 col-lg-8 mx-auto"></div>
        <div class="col-lg-8 mx-auto mt-4 text-center">
            <button class="btn btn-outline-secondary" onclick="location.reload()">Yeni Arama</button>
        </div>
    </div>

    <!-- 3. SORU EKRANI -->
    <div id="quiz-panel" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white p-3 shadow-sm rounded z-3">
            <h5 id="currentCourseTitle" class="m-0 text-truncate fw-bold text-primary">Ders Adı</h5>
            <button class="btn btn-danger btn-sm px-3" onclick="switchPanel('course-panel')">Kapat</button>
        </div>
        
        <div id="questions-container" class="col-lg-8 mx-auto pb-5"></div>
        
        <div class="fixed-bottom bg-white border-top p-3 text-center shadow-lg">
            <button class="btn btn-success px-5 fw-bold" onclick="switchPanel('course-panel')">Bitir ve Listeye Dön</button>
        </div>
    </div>

</div>

<!-- YÜKLENİYOR -->
<div id="loading" class="loading-overlay hidden">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="mt-4 fw-bold">İşleniyor</h4>
    <p id="loadingLog" class="log-text">Başlatılıyor...</p>
</div>

<script>
    const BASE_URL = "https://aofsoru.com";
    let examData = [];

    // Proxy Servisleri
    const PROXIES = [
        { url: "https://api.codetabs.com/v1/proxy?quest=", type: "text" }, 
        { url: "https://api.allorigins.win/get?url=", type: "json" },
        { url: "https://corsproxy.io/?", type: "text" }
    ];

    async function fetchWithFallback(targetUrl) {
        for (let i = 0; i < PROXIES.length; i++) {
            const proxy = PROXIES[i];
            const fullUrl = proxy.url + encodeURIComponent(targetUrl);
            updateLog(`Sunucu deneniyor (${i+1}/${PROXIES.length})...`);
            
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) throw new Error("Proxy hatası");

                let htmlContent = "";
                if (proxy.type === "json") {
                    const data = await response.json();
                    htmlContent = data.contents;
                } else {
                    htmlContent = await response.text();
                }

                if (!htmlContent || htmlContent.length < 500) throw new Error("Eksik veri");
                return htmlContent;

            } catch (error) {
                console.warn(`Proxy ${i+1} başarısız.`);
            }
        }
        return null;
    }

    function parseHtml(htmlString) {
        return new DOMParser().parseFromString(htmlString, "text/html");
    }

    async function startProcess() {
        const input = document.querySelector('.url-input');
        const url = input.value.trim();
        const yearLimit = parseInt(document.getElementById('yearLimit').value);
        const examType = document.getElementById('examType').value;

        if (!url) { alert("Lütfen link girin."); return; }

        showLoading(true);
        examData = [];

        let targetUrl = url.startsWith('http') ? url : 'https://' + url;
        
        updateLog("Ders sayfası analiz ediliyor...");
        const courseHtml = await fetchWithFallback(targetUrl);
        
        if (!courseHtml) {
            alert("Siteye erişilemedi.");
            showLoading(false);
            return;
        }

        const doc = parseHtml(courseHtml);
        let title = doc.querySelector('h1')?.innerText.replace('Soruları', '').trim() || "Ders";
        
        updateLog("Sınavlar filtreleniyor...");
        const links = getExamLinks(doc, examType, yearLimit);

        if (links.length > 0) {
            updateLog(`${links.length} sınav bulunudu. Sorular çekiliyor...`);
            const questions = await scrapeQuestionsFromLinks(links);
            if (questions.length > 0) {
                examData.push({ title, questions });
                renderCourses();
                switchPanel('course-panel');
            } else {
                alert("Soru çekilemedi. Site yapısı değişmiş olabilir.");
            }
        } else {
            alert("Kriterlere uygun sınav linki bulunamadı.");
        }
        showLoading(false);
    }

    // --- YIL MANTIĞI DÜZELTİLDİ ---
    function getExamLinks(doc, type, limit) {
        const targetText = type === "vize" ? "ARA" : "DÖNEM SONU";
        let validLinks = [];
        
        const allLinks = doc.querySelectorAll('a');
        allLinks.forEach(link => {
            const title = (link.getAttribute('title') || "").toUpperCase();
            const href = link.getAttribute('href');
            
            if (title.includes(targetText) && href) {
                // Sadece 4 haneli yılı al (Örn: 2023)
                const yearMatch = title.match(/(\d{4})/); 
                let year = yearMatch ? parseInt(yearMatch[0]) : 0;
                
                let fullUrl = href.startsWith('http') ? href : BASE_URL + (href.startsWith('/') ? '' : '/') + href;
                
                validLinks.push({ url: fullUrl, year, title });
            }
        });
        
        // Yıla göre sırala (En yeni en üstte)
        validLinks.sort((a, b) => b.year - a.year);
        
        // --- ÖNEMLİ: EŞSİZLİK KONTROLÜ ---
        // Aynı URL'yi birden fazla eklememek için:
        const uniqueLinks = [];
        const seenUrls = new Set();
        
        for (const item of validLinks) {
            if (!seenUrls.has(item.url)) {
                seenUrls.add(item.url);
                uniqueLinks.push(item);
            }
        }

        // Limit kadar al (Artık 0,1,2,3 -> 4 tane kesin alır)
        return uniqueLinks.slice(0, limit);
    }

    // --- CEVAP ANAHTARI ANALİZİ ---
    async function scrapeQuestionsFromLinks(links) {
        let allQuestions = [];
        
        for (let link of links) {
            updateLog(`İşleniyor: ${link.year} Sınavı`);
            await new Promise(r => setTimeout(r, 800)); // Engel yememek için bekle
            
            const html = await fetchWithFallback(link.url);
            if (!html) continue;

            const doc = parseHtml(html);
            
            // 1. STRATEJİ: Sayfadaki Scriptlerde JSON Dizi Arama
            // Site genellikle cevapları ["A", "C", "D"] gibi bir dizi içinde tutar.
            let answers = [];
            
            // Tüm script taglerini al ve içlerinde cevap anahtarına benzeyen yapıları ara
            const scripts = doc.querySelectorAll('script');
            for(let script of scripts) {
                const content = script.innerText;
                if(!content) continue;

                // Regex: ["A", "B", "C"...] gibi duran yapıları bul
                // Bu regex, içinde sadece A-E harfleri olan virgülle ayrılmış dizileri arar.
                const arrayRegex = /\[\s*(["'][A-E]["']\s*,?\s*){5,}\]/g; 
                const match = content.match(arrayRegex);
                
                if (match) {
                    // En uzun eşleşen diziyi muhtemelen cevap anahtarıdır
                    const potentialKey = match.reduce((a, b) => a.length > b.length ? a : b);
                    // Temizle ve diziye çevir
                    answers = potentialKey.replace(/[\[\]"']/g, '').split(',').map(s => s.trim());
                    if(answers.length > 5) break; // Bulduysak döngüden çık
                }
            }

            // 2. STRATEJİ (Yedek): Eğer dizi bulamazsa, tekil değişkenleri ara (cvp='A')
            if (answers.length === 0) {
                 const singleRegex = /["']?Cevap["']?\s*[:=]\s*["']([A-E])["']/gi;
                 let m;
                 while ((m = singleRegex.exec(html)) !== null) {
                     answers.push(m[1]);
                 }
            }

            const imgs = doc.querySelectorAll('img.QuestionImg');
            imgs.forEach((img, index) => {
                let src = img.getAttribute('data-src') || img.getAttribute('src');
                if (src) {
                    src = src.trim();
                    if (src.startsWith('//')) src = 'https:' + src;
                    else if (src.startsWith('/')) src = 'https://image.aofsoru.com' + src;
                    else if (!src.startsWith('http')) src = BASE_URL + '/' + src;

                    // Cevabı belirle
                    let correctAnswer = "Bilinmiyor";
                    
                    // Diziden çek
                    if (answers.length > index) {
                        correctAnswer = answers[index].toUpperCase();
                    } 
                    // HTML'den çek (Yeşil buton kontrolü - çok nadir çalışır ama kalsın)
                    else {
                        let parent = img.closest('.card') || img.parentElement.parentElement;
                        if(parent) {
                             const btn = parent.querySelector('.btn-success');
                             if(btn) correctAnswer = btn.innerText.trim();
                        }
                    }

                    allQuestions.push({
                        image: src,
                        answer: correctAnswer,
                        info: `${link.year} - ${link.title}`
                    });
                }
            });
        }
        return allQuestions;
    }

    // --- UI ---
    function renderCourses() {
        const list = document.getElementById('course-list');
        list.innerHTML = "";
        examData.forEach((course, index) => {
            list.innerHTML += `
                <div class="card p-4 shadow-sm" onclick="startQuiz(${index})" style="cursor:pointer; border-left:6px solid #0d6efd">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="m-0 fw-bold text-dark">${course.title}</h5>
                            <small class="text-muted">${course.questions.length} Soru Hazır</small>
                        </div>
                        <i class="material-icons text-primary" style="font-size:2rem">play_arrow</i>
                    </div>
                </div>`;
        });
    }

    function startQuiz(index) {
        const course = examData[index];
        document.getElementById('currentCourseTitle').innerText = course.title;
        const container = document.getElementById('questions-container');
        container.innerHTML = "";

        course.questions.forEach((q, i) => {
            container.innerHTML += `
                <div class="card mb-5">
                    <div class="card-header bg-white py-3 d-flex justify-content-between">
                        <span class="badge bg-dark rounded-pill">Soru ${i+1}</span>
                        <small class="text-muted fw-bold">${q.info}</small>
                    </div>
                    <div class="card-body text-center p-0">
                        <div class="bg-light p-3 border-bottom">
                            <img src="${q.image}" class="question-img shadow-sm" loading="lazy" 
                                 onerror="this.parentElement.innerHTML='<div class=\'alert alert-danger\'>Resim Yüklenemedi</div>';">
                        </div>
                        
                        <div class="py-4 px-2" id="opts-${i}">
                            <div class="d-flex justify-content-center flex-wrap gap-2">
                                ${['A','B','C','D','E'].map(opt => 
                                    `<button class="btn btn-circle" onclick="check(this, '${opt}', '${q.answer}', ${i})">${opt}</button>`
                                ).join('')}
                            </div>
                        </div>
                        <div id="fb-${i}" class="pb-3 fw-bold" style="min-height:40px"></div>
                    </div>
                </div>`;
        });
        switchPanel('quiz-panel');
        window.scrollTo(0,0);
    }

    window.check = function(btn, selected, correct, id) {
        const parent = document.getElementById(`opts-${id}`);
        const fb = document.getElementById(`fb-${id}`);
        parent.querySelectorAll('button').forEach(b => b.disabled = true);

        if (!correct || correct === "Bilinmiyor") {
            fb.innerHTML = "<div class='alert alert-warning d-inline-block'>Cevap anahtarı sistemde gizli.</div>";
            return;
        }

        if (selected === correct) {
            btn.classList.add('correct-green');
            fb.innerHTML = "<div class='alert alert-success d-inline-block px-4'><i class='material-icons align-middle'>check</i> Doğru!</div>";
        } else {
            btn.classList.add('wrong-red');
            fb.innerHTML = `<div class='alert alert-danger d-inline-block px-4'><i class='material-icons align-middle'>close</i> Yanlış. Cevap: ${correct}</div>`;
            Array.from(parent.children).forEach(b => {
                if(b.innerText.trim() === correct) b.classList.add('correct-green');
            });
        }
    }

    function switchPanel(id) {
        ['setup-panel','course-panel','quiz-panel'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function updateLog(msg) {
        document.getElementById('loadingLog').innerText = msg;
    }
</script>

</body>
</html>
