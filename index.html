<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AÖF Robotu (V7 - Link Generator)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f1f3f5; font-family: sans-serif; }
        .hidden { display: none !important; }
        .card { border-radius: 10px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .question-img { max-width: 100%; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; }
        .btn-option { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #555; background: #fff; font-weight: bold; margin: 5px; color: #333; }
        .btn-option:hover { background: #555; color: #fff; }
        .correct { background: #198754 !important; color: white !important; border-color: #198754 !important; }
        .wrong { background: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:999; flex-direction:column; }
    </style>
</head>
<body>

<div class="container py-5">
    
    <!-- GİRİŞ -->
    <div id="setup" class="row justify-content-center">
        <div class="col-md-8">
            <div class="card p-4">
                <h3 class="text-center text-primary fw-bold mb-3">AÖF Sınav Robotu V7</h3>
                <div class="alert alert-info small">
                    Bu versiyon linkleri otomatik üretir, böylece eksik yıl sorunu yaşanmaz.
                </div>
                
                <label class="fw-bold">Ders Linki</label>
                <input type="text" id="urlInput" class="form-control mb-3" placeholder="https://aofsoru.com/..." >
                
                <div class="row">
                    <div class="col-6">
                        <label class="fw-bold">Başlangıç Yılı</label>
                        <select id="startYear" class="form-select">
                            <option value="2024">2024 - 2025</option>
                            <option value="2023">2023 - 2024</option>
                            <option value="2022">2022 - 2023</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="fw-bold">Geriye Dönük Kaç Sınav?</label>
                        <select id="countLimit" class="form-select">
                            <option value="3">Son 3 Sınav</option>
                            <option value="4" selected>Son 4 Sınav</option>
                            <option value="6">Son 6 Sınav</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="fw-bold">Sınav Türü</label>
                    <select id="examType" class="form-select">
                        <option value="ara">Ara Sınav (Vize)</option>
                        <option value="donem-sonu">Dönem Sonu (Final)</option>
                        <option value="tek-ders">Tek Ders Sınavı</option>
                        <option value="yaz-okulu">Yaz Okulu</option>
                    </select>
                </div>

                <button class="btn btn-primary w-100 mt-4 btn-lg" onclick="startGen()">Soruları Getir</button>
            </div>
        </div>
    </div>

    <!-- SORULAR -->
    <div id="quiz" class="hidden">
        <div class="d-flex justify-content-between mb-3 bg-white p-3 rounded shadow-sm sticky-top">
            <h5 id="courseTitle" class="m-0 text-truncate" style="max-width:70%">Ders</h5>
            <button class="btn btn-sm btn-danger" onclick="location.reload()">Kapat</button>
        </div>
        <div id="qContainer" class="col-md-8 mx-auto pb-5"></div>
    </div>

</div>

<div id="loader" class="loading hidden">
    <div class="spinner-border text-primary"></div>
    <div class="mt-2" id="logMsg">Başlatılıyor...</div>
</div>

<script>
    const PROXIES = [
        "https://api.codetabs.com/v1/proxy?quest=",
        "https://corsproxy.io/?",
        "https://api.allorigins.win/get?url="
    ];

    async function fetchUrl(url) {
        for(let proxy of PROXIES) {
            try {
                // AllOrigins JSON döner, diğerleri Text
                const isJson = proxy.includes('allorigins');
                const res = await fetch(proxy + encodeURIComponent(url));
                if(!res.ok) continue;
                
                if(isJson) {
                    const data = await res.json();
                    if(data.contents) return data.contents;
                } else {
                    const text = await res.text();
                    if(text && text.length > 500) return text;
                }
            } catch(e){}
        }
        return null;
    }

    async function startGen() {
        const urlInp = document.getElementById('urlInput').value.trim();
        const startYear = parseInt(document.getElementById('startYear').value);
        const limit = parseInt(document.getElementById('countLimit').value);
        const type = document.getElementById('examType').value;

        if(!urlInp) { alert("Link giriniz"); return; }

        // 1. ADIM: DERS SLUG'INI AYIKLA
        // URL: https://aofsoru.com/adl201u-buro-teknolojileri-dersi-sinav-sorulari
        // Slug: adl201u-buro-teknolojileri-dersi
        let slug = "";
        try {
            const cleanUrl = urlInp.replace('https://', '').replace('http://', '').replace('www.', '').replace('aofsoru.com/', '');
            // Eğer URL zaten bir sınav linki ise onu temizle
            slug = cleanUrl.split('-sinav-sorulari')[0]; 
            // Eğer URL içinde yıl varsa onu da temizle (2021-2022-yili-ara-sinavi...)
            slug = slug.replace(/-\d{4}-\d{4}-yili.*/, ''); 
            slug = slug.replace(/-ara-sinavi.*/, '');
            slug = slug.replace(/-donem-sonu.*/, '');
        } catch(e) {
            alert("Link formatı anlaşılamadı. Lütfen dersin ana sayfa linkini girin.");
            return;
        }

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('loader').classList.remove('hidden');

        let questions = [];

        // 2. ADIM: LİNKLERİ MATEMATİKSEL OLARAK ÜRET
        for (let i = 0; i < limit; i++) {
            let currentY = startYear - i;
            let nextY = currentY + 1;
            
            // Oluşturulan URL Örneği:
            // https://aofsoru.com/adl201u-buro-teknolojileri-dersi-2021-2022-yili-ara-sinavi-sinav-sorulari
            let generatedUrl = `https://aofsoru.com/${slug}-${currentY}-${nextY}-yili-${type}-sinavi-sinav-sorulari`;
            
            document.getElementById('logMsg').innerText = `${currentY}-${nextY} sınavı taranıyor...`;
            
            const html = await fetchUrl(generatedUrl);
            if(html) {
                // Cevap Anahtarı Arama (Regex ile)
                let answers = [];
                // Scriptlerdeki dizileri ara
                const arrayMatches = html.match(/\[\s*(["'][A-E]["']\s*,?\s*){5,}\]/g);
                if(arrayMatches) {
                    const best = arrayMatches.reduce((a,b)=>a.length>b.length?a:b);
                    answers = best.replace(/[\[\]"']/g, '').split(',');
                }
                
                const doc = new DOMParser().parseFromString(html, "text/html");
                const imgs = doc.querySelectorAll('img.QuestionImg');
                
                imgs.forEach((img, idx) => {
                    let src = img.getAttribute('data-src') || img.getAttribute('src');
                    if(src) {
                        if(src.startsWith('//')) src = 'https:'+src;
                        else if(src.startsWith('/')) src = 'https://image.aofsoru.com'+src;
                        
                        let ans = "X"; // Bilinmiyor
                        if(answers.length > idx) ans = answers[idx].trim();

                        questions.push({
                            img: src,
                            ans: ans,
                            title: `${currentY}-${nextY} ${type.toUpperCase()}`
                        });
                    }
                });
            } else {
                console.log("Bu yıl bulunamadı:", generatedUrl);
            }
            
            // Hızlı istek atıp banlanmamak için bekle
            await new Promise(r => setTimeout(r, 500));
        }

        if(questions.length > 0) {
            showQuiz(questions);
        } else {
            alert("Hiçbir sınav bulunamadı. Linki veya Başlangıç Yılını kontrol edin.");
            location.reload();
        }
    }

    function showQuiz(data) {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('quiz').classList.remove('hidden');
        document.getElementById('courseTitle').innerText = document.getElementById('urlInput').value; // Basit başlık
        
        const c = document.getElementById('qContainer');
        c.innerHTML = "";
        
        data.forEach((q, i) => {
            c.innerHTML += `
            <div class="card p-3 mb-4 text-center">
                <div class="badge bg-secondary mb-2">${q.title} - Soru ${i+1}</div>
                <img src="${q.img}" class="question-img" loading="lazy" onerror="this.style.display='none'">
                <div class="mt-3" id="optbox-${i}">
                    ${['A','B','C','D','E'].map(o => 
                        `<button class="btn-option" onclick="check(this, '${o}', '${q.ans}', ${i})">${o}</button>`
                    ).join('')}
                </div>
                <div id="res-${i}" class="fw-bold mt-2"></div>
            </div>`;
        });
    }

    window.check = function(btn, sel, correct, id) {
        const box = document.getElementById(`optbox-${id}`);
        const res = document.getElementById(`res-${id}`);
        
        // Butonları kilitle
        Array.from(box.children).forEach(b => b.disabled = true);

        if(correct === "X") {
            // Cevap yoksa sadece seçileni işaretle
            btn.style.background = "#ffc107"; // Sarı
            res.innerHTML = "<span class='text-warning'>Cevap anahtarı sistemde bulunamadı.</span>";
            return;
        }

        if(sel === correct) {
            btn.classList.add('correct');
            res.innerHTML = "<span class='text-success'>DOĞRU!</span>";
        } else {
            btn.classList.add('wrong');
            res.innerHTML = `<span class='text-danger'>YANLIŞ! Doğru: ${correct}</span>`;
            // Doğruyu göster
            Array.from(box.children).find(b=>b.innerText===correct)?.classList.add('correct');
        }
    }
</script>
</body>
</html>
