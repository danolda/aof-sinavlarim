<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AÖF Sınav Robotu (V4 - Script Analiz)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none !important; }
        
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .question-img { 
            max-width: 100%; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            margin: 15px 0;
            background-color: #fff;
        }
        
        .btn-circle { 
            width: 50px; height: 50px; border-radius: 50%; padding: 0; 
            font-size: 1.2rem; font-weight: bold; margin: 0 8px; 
            border: 2px solid #6c757d; color: #6c757d; background: white; 
            transition: all 0.2s;
        }
        .btn-circle:hover { background-color: #6c757d; color: white; transform: scale(1.1); }
        
        .correct-green { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
        .wrong-red { background-color: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .log-text { font-size: 0.9rem; color: #6c757d; margin-top: 10px; font-family: monospace; }
        
        .course-item { transition: transform 0.2s; border-left: 6px solid #0d6efd; }
        .course-item:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container py-5">
    
    <!-- 1. AYAR PANELİ -->
    <div id="setup-panel" class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-5">
                <div class="text-center mb-5">
                    <h2 class="fw-bold text-primary">AÖF Sınav Robotu</h2>
                    <p class="text-muted">Linkleri girin, soruları ve gizli cevapları çekelim.</p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold text-dark">Ders Linki (Aofsoru.com)</label>
                    <div id="urlContainer">
                        <input type="text" class="form-control mb-2 url-input form-control-lg" placeholder="https://aofsoru.com/..." >
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Dönem Limiti</label>
                        <select id="yearLimit" class="form-select form-select-lg">
                            <option value="4" selected>Son 4 Sınav</option>
                            <option value="5">Son 5 Sınav</option>
                            <option value="8">Son 8 Sınav</option>
                            <option value="20">Tüm Sınavlar</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Sınav Türü</label>
                        <select id="examType" class="form-select form-select-lg">
                            <option value="vize">Ara Sınav (Vize)</option>
                            <option value="final">Dönem Sonu (Final)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary w-100 btn-lg mt-5 py-3 fw-bold" onclick="startProcess()">
                    Sınavı Oluştur
                </button>
            </div>
        </div>
    </div>

    <!-- 2. DERS LİSTESİ -->
    <div id="course-panel" class="hidden">
        <h3 class="text-center mb-4 fw-bold">Bulunan Sınavlar</h3>
        <div id="course-list" class="d-grid gap-3 col-lg-8 mx-auto"></div>
        <div class="col-lg-8 mx-auto mt-4">
            <button class="btn btn-secondary w-100" onclick="location.reload()">Yeni Sorgu Yap</button>
        </div>
    </div>

    <!-- 3. SORU ÇÖZME EKRANI -->
    <div id="quiz-panel" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white p-3 shadow-sm rounded z-3">
            <h5 id="currentCourseTitle" class="m-0 text-truncate fw-bold text-primary">Ders Adı</h5>
            <button class="btn btn-outline-danger btn-sm px-3" onclick="switchPanel('course-panel')">Kapat</button>
        </div>
        
        <div id="questions-container" class="col-lg-8 mx-auto pb-5"></div>
        
        <div class="fixed-bottom bg-white border-top p-3 text-center shadow-lg">
            <button class="btn btn-success px-5" onclick="switchPanel('course-panel')">Sınavı Bitir ve Dön</button>
        </div>
    </div>

</div>

<!-- YÜKLENİYOR -->
<div id="loading" class="loading-overlay hidden">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="mt-4 fw-bold">Veriler İşleniyor</h4>
    <p id="loadingLog" class="log-text">Bağlantı kuruluyor...</p>
</div>

<script>
    const BASE_URL = "https://aofsoru.com";
    let examData = [];

    // Proxy Servisleri (Sırasıyla dener)
    const PROXIES = [
        { url: "https://api.codetabs.com/v1/proxy?quest=", type: "text" }, 
        { url: "https://api.allorigins.win/get?url=", type: "json" },
        { url: "https://corsproxy.io/?", type: "text" }
    ];

    async function fetchWithFallback(targetUrl) {
        for (let i = 0; i < PROXIES.length; i++) {
            const proxy = PROXIES[i];
            const fullUrl = proxy.url + encodeURIComponent(targetUrl);
            updateLog(`Sunucu deneniyor (${i+1}/${PROXIES.length})...`);
            
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) throw new Error("Proxy hatası");

                let htmlContent = "";
                if (proxy.type === "json") {
                    const data = await response.json();
                    htmlContent = data.contents;
                } else {
                    htmlContent = await response.text();
                }

                if (!htmlContent || htmlContent.length < 500) throw new Error("Eksik veri");
                return htmlContent;

            } catch (error) {
                console.warn(`Proxy ${i+1} başarısız.`);
            }
        }
        return null;
    }

    function parseHtml(htmlString) {
        return new DOMParser().parseFromString(htmlString, "text/html");
    }

    async function startProcess() {
        const inputs = document.querySelectorAll('.url-input');
        const urls = Array.from(inputs).map(i => i.value.trim()).filter(v => v !== "");
        const yearLimit = parseInt(document.getElementById('yearLimit').value);
        const examType = document.getElementById('examType').value;

        if (urls.length === 0) { alert("Lütfen ders linkini yapıştırın."); return; }

        showLoading(true);
        examData = [];

        for (let url of urls) {
            if (!url.startsWith('http')) url = 'https://' + url;

            updateLog("Ders ana sayfası analiz ediliyor...");
            const courseHtml = await fetchWithFallback(url);
            
            if (!courseHtml) {
                alert("Siteye erişilemedi. Lütfen sayfayı yenileyip tekrar deneyin.");
                continue;
            }

            const doc = parseHtml(courseHtml);
            let title = doc.querySelector('h1')?.innerText.replace('Soruları', '').trim() || "Ders";
            
            updateLog("Sınav linkleri taranıyor...");
            const links = getExamLinks(doc, examType, yearLimit);

            if (links.length > 0) {
                updateLog(`${links.length} adet sınav bulundu. Sorular çekiliyor...`);
                const questions = await scrapeQuestionsFromLinks(links);
                if (questions.length > 0) {
                    examData.push({ title, questions });
                }
            } else {
                 alert("Seçilen kriterlere uygun sınav linki bulunamadı. (Yıl veya Sınav Türü ayarını kontrol edin)");
            }
        }

        showLoading(false);
        if (examData.length > 0) {
            renderCourses();
            switchPanel('course-panel');
        }
    }

    // --- YIL BULMA VE FİLTRELEME (GÜNCELLENDİ) ---
    function getExamLinks(doc, type, limit) {
        const targetText = type === "vize" ? "ARA" : "DÖNEM SONU";
        let validLinks = [];
        
        const allLinks = doc.querySelectorAll('a');
        allLinks.forEach(link => {
            const title = (link.getAttribute('title') || "").toUpperCase();
            const href = link.getAttribute('href');
            
            // Link başlığında ARA veya DÖNEM SONU geçiyorsa
            if (title.includes(targetText) && href) {
                
                // Yıl Bulma (Regex Güncellendi: Sadece ilk 4 haneli sayıyı alır)
                // Örn: "2024-2025" -> 2024 alır. "2023 Yaz" -> 2023 alır.
                const yearMatch = title.match(/(\d{4})/);
                let year = yearMatch ? parseInt(yearMatch[0]) : 0;
                
                // URL düzeltme
                let fullUrl = href.startsWith('http') ? href : BASE_URL + (href.startsWith('/') ? '' : '/') + href;
                
                validLinks.push({ url: fullUrl, year, title });
            }
        });
        
        // Yıla göre yeniden eskiye sırala
        validLinks.sort((a, b) => b.year - a.year);
        
        // Benzersiz URL'leri filtrele (Aynı sınavı iki kere eklemesin)
        const uniqueLinks = [];
        const seenUrls = new Set();
        for(const item of validLinks) {
            if(!seenUrls.has(item.url)){
                seenUrls.add(item.url);
                uniqueLinks.push(item);
            }
        }

        // Limiti uygula
        return uniqueLinks.slice(0, limit);
    }

    // --- SORU VE GİZLİ CEVAP ÇEKME ---
    async function scrapeQuestionsFromLinks(links) {
        let allQuestions = [];
        for (let link of links) {
            updateLog(`İşleniyor: ${link.title}`);
            await new Promise(r => setTimeout(r, 800)); // Bekleme süresi
            
            const html = await fetchWithFallback(link.url);
            if (!html) continue;

            // 1. Cevap Anahtarını Script İçinden Bul (Regex ile)
            // Site genellikle JSON formatında "Cevap":"A" şeklinde veri saklar.
            // Regex: "Cevap" : "A"  veya 'Cevap':'A' gibi desenleri arar.
            // AOF siteleri genelde soruları sırayla basar, script de sırayla olur.
            
            let scriptAnswers = [];
            // Regex açıklaması: "Cevap" kelimesi, ardından : , ardından " veya ' , ardından A-E arası harf
            const answerRegex = /["']?Cevap["']?\s*[:=]\s*["']([A-E])["']/gi;
            let match;
            while ((match = answerRegex.exec(html)) !== null) {
                scriptAnswers.push(match[1]);
            }

            // HTML'i parse et
            const doc = parseHtml(html);
            const imgs = doc.querySelectorAll('img.QuestionImg');

            imgs.forEach((img, index) => {
                // Resim Kaynağı
                let src = img.getAttribute('data-src') || img.getAttribute('src');
                if (src) {
                    src = src.trim();
                    if (src.startsWith('//')) src = 'https:' + src;
                    else if (src.startsWith('/')) src = 'https://image.aofsoru.com' + src;
                    else if (!src.startsWith('http')) src = BASE_URL + '/' + src;

                    // Cevap Eşleştirme
                    // Eğer script'ten cevap bulduysak sırasına göre al, yoksa "Bilinmiyor"
                    let answer = "Bilinmiyor";
                    if (scriptAnswers.length > index) {
                        answer = scriptAnswers[index].toUpperCase();
                    } else {
                        // Yedek plan: Belki cevap HTML'dedir (Nadir)
                        let parent = img.closest('.card') || img.closest('.card-body') || img.parentElement.parentElement;
                        if(parent) {
                             const btn = parent.querySelector('.btn-success');
                             if(btn) answer = btn.innerText.trim();
                        }
                    }

                    allQuestions.push({
                        image: src,
                        answer: answer,
                        info: link.title
                    });
                }
            });
        }
        return allQuestions;
    }

    // --- ARAYÜZ İŞLEMLERİ ---
    function renderCourses() {
        const list = document.getElementById('course-list');
        list.innerHTML = "";
        examData.forEach((course, index) => {
            list.innerHTML += `
                <div class="card p-4 shadow-sm course-item" onclick="startQuiz(${index})" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="m-0 fw-bold text-dark">${course.title}</h5>
                            <small class="text-muted">${course.questions.length} Soru Hazır</small>
                        </div>
                        <i class="material-icons text-primary" style="font-size:2rem">play_circle_filled</i>
                    </div>
                </div>`;
        });
    }

    function startQuiz(index) {
        const course = examData[index];
        document.getElementById('currentCourseTitle').innerText = course.title;
        const container = document.getElementById('questions-container');
        container.innerHTML = "";

        course.questions.forEach((q, i) => {
            container.innerHTML += `
                <div class="card mb-5">
                    <div class="card-header bg-white py-3 border-bottom">
                        <span class="badge bg-secondary me-2">${i+1}</span> 
                        <small class="text-muted fw-bold">${q.info}</small>
                    </div>
                    <div class="card-body text-center p-0">
                        <div style="background:#f8f9fa; padding:20px; min-height:200px; display:flex; align-items:center; justify-content:center;">
                            <img src="${q.image}" class="question-img shadow-sm" loading="lazy" 
                                 onerror="this.onerror=null; this.parentElement.innerHTML='<span class=text-danger>Resim Yüklenemedi</span>';">
                        </div>
                        
                        <div class="py-4" id="opts-${i}">
                            <div class="d-flex justify-content-center flex-wrap gap-2">
                                ${['A','B','C','D','E'].map(opt => 
                                    `<button class="btn btn-circle" onclick="check(this, '${opt}', '${q.answer}', ${i})">${opt}</button>`
                                ).join('')}
                            </div>
                        </div>
                        <div id="fb-${i}" class="pb-3 fw-bold" style="min-height:30px"></div>
                    </div>
                </div>`;
        });
        switchPanel('quiz-panel');
        window.scrollTo(0,0);
    }

    window.check = function(btn, selected, correct, id) {
        const parent = document.getElementById(`opts-${id}`);
        const fb = document.getElementById(`fb-${id}`);
        
        // Butonları kilitle
        parent.querySelectorAll('button').forEach(b => b.disabled = true);

        // Cevap Kontrolü
        if (!correct || correct === "Bilinmiyor") {
            fb.innerHTML = "<div class='alert alert-warning d-inline-block py-1 px-3'>Cevap Anahtarı Çekilemedi</div>";
            return;
        }

        if (selected === correct) {
            btn.classList.add('correct-green');
            fb.innerHTML = "<div class='alert alert-success d-inline-block py-1 px-3'><i class='material-icons align-middle' style='font-size:1.2rem'>check</i> Doğru!</div>";
        } else {
            btn.classList.add('wrong-red');
            fb.innerHTML = `<div class='alert alert-danger d-inline-block py-1 px-3'><i class='material-icons align-middle' style='font-size:1.2rem'>close</i> Yanlış. Doğru Cevap: ${correct}</div>`;
            
            // Doğru şıkkı göster
            Array.from(parent.children).forEach(b => {
                if(b.innerText.trim() === correct) b.classList.add('correct-green');
            });
        }
    }

    function switchPanel(id) {
        ['setup-panel','course-panel','quiz-panel'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function updateLog(msg) {
        document.getElementById('loadingLog').innerText = msg;
    }
</script>

</body>
</html>
