<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AÖF & ATA Sınav Robotu V18 (Final + Mobil Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --sidebar-active: #0d6efd;
            --sidebar-active-text: #ffffff;
            --nav-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
            --sidebar-active: #bb86fc;
            --sidebar-active-text: #000000;
            --nav-bg: #1e1e1e;
        }

        body { background-color: var(--bg-body); color: var(--text-color); transition: 0.3s; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: var(--bg-card); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; }
        .form-control, .form-select, .input-group-text { background-color: var(--bg-card); color: var(--text-color); border-color: var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--bg-card); color: var(--text-color); box-shadow: none; border-color: var(--sidebar-active); }

        .sidebar-item {
            padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 8px;
            transition: all 0.2s; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-item:hover { background-color: rgba(128,128,128,0.1); }
        .sidebar-item.active { background-color: var(--sidebar-active); color: var(--sidebar-active-text); font-weight: bold; }
        
        .sidebar-mistakes { border: 1px solid #dc3545; color: #dc3545; background: rgba(220, 53, 69, 0.05); font-weight: bold; }
        .sidebar-mistakes:hover { background: rgba(220, 53, 69, 0.1); }
        .sidebar-mistakes.active { background: #dc3545; color: white; }

        .stat-badge { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; min-width: 20px; text-align: center; }

        .question-img { 
            max-width: 100%; border: 1px solid var(--border-color); border-radius: 8px; 
            margin: 15px 0; background: #fff; padding: 5px; min-height: 100px;
        }

        .uni-tab { cursor: pointer; border-bottom: 3px solid transparent; padding: 10px 20px; font-weight: bold; color: var(--text-color); opacity: 0.6; }
        .uni-tab:hover { opacity: 1; }
        .uni-tab.active { border-bottom: 3px solid var(--sidebar-active); color: var(--sidebar-active); opacity: 1; }

        .btn-circle { 
            width: 50px; height: 50px; border-radius: 50%; padding: 0; 
            font-size: 1.2rem; font-weight: bold; margin: 0 6px; 
            border: 2px solid #6c757d; color: #6c757d; background: var(--bg-card); 
            transition: all 0.2s;
        }
        .btn-circle:hover { background-color: #6c757d; color: white; transform: scale(1.1); }
        .correct-green { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
        .wrong-red { background-color: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }

        .hidden { display: none !important; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-card); opacity: 0.98; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .scroll-top-wrapper { margin-top: 30px; padding-top: 20px; border-top: 1px dashed var(--border-color); text-align: center; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg border-bottom px-3" style="background-color: var(--nav-bg);">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-robot"></i> Sınav Robotu V18</a>
        
        <div class="d-flex mx-auto">
            <div class="uni-tab active" id="tab-anadolu">ANADOLU AÖF</div>
            <div class="uni-tab" id="tab-ata">ATA AÖF</div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-danger btn-sm hidden" id="globalResetBtn">
                <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="themeBtn">
                <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
            </button>
        </div>
    </div>
</nav>

<div class="container py-4">
    
    <div id="setup-panel">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card p-5 shadow-lg">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold" id="panel-title">Anadolu AÖF Sınav Robotu</h3>
                        <p class="text-muted" id="panel-desc">Ders linklerini ve kaç sınav çekileceğini girin.</p>
                        <small class="text-info"><i class="bi bi-info-circle"></i> Mobil linkler otomatik düzeltilir</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Ders Linkleri & Sınav Sayısı</label>
                            
                            <div id="input-container">
                                <div class="input-group mb-2 course-row">
                                    <span class="input-group-text">1</span>
                                    <input type="text" class="form-control url-input" placeholder="Ders Linki...">
                                    <select class="form-select limit-input" style="max-width: 130px;">
                                        <option value="2">2 Sınav</option>
                                        <option value="3">3 Sınav</option>
                                        <option value="4" selected>4 Sınav</option>
                                        <option value="5">5 Sınav</option>
                                        <option value="6">6 Sınav</option>
                                        <option value="8">8 Sınav</option>
                                        <option value="10">10 Sınav</option>
                                    </select>
                                </div>
                                <div class="input-group mb-2 course-row">
                                    <span class="input-group-text">2</span>
                                    <input type="text" class="form-control url-input" placeholder="Ders Linki...">
                                    <select class="form-select limit-input" style="max-width: 130px;">
                                        <option value="4" selected>4 Sınav</option>
                                        <option value="5">5 Sınav</option>
                                        <option value="6">6 Sınav</option>
                                        <option value="8">8 Sınav</option>
                                        <option value="10">10 Sınav</option>
                                    </select>
                                </div>
                                <div class="input-group mb-2 course-row">
                                    <span class="input-group-text">3</span>
                                    <input type="text" class="form-control url-input" placeholder="Ders Linki...">
                                    <select class="form-select limit-input" style="max-width: 130px;">
                                        <option value="4" selected>4 Sınav</option>
                                        <option value="5">5 Sınav</option>
                                        <option value="6">6 Sınav</option>
                                    </select>
                                </div>
                                <div class="input-group mb-2 course-row">
                                    <span class="input-group-text">4</span>
                                    <input type="text" class="form-control url-input" placeholder="Ders Linki...">
                                    <select class="form-select limit-input" style="max-width: 130px;">
                                        <option value="4" selected>4 Sınav</option>
                                    </select>
                                </div>
                                <div class="input-group mb-2 course-row">
                                    <span class="input-group-text">5</span>
                                    <input type="text" class="form-control url-input" placeholder="Ders Linki...">
                                    <select class="form-select limit-input" style="max-width: 130px;">
                                        <option value="4" selected>4 Sınav</option>
                                    </select>
                                </div>
                                <div class="input-group mb-2 course-row">
                                    <span class="input-group-text">6</span>
                                    <input type="text" class="form-control url-input" placeholder="Ders Linki...">
                                    <select class="form-select limit-input" style="max-width: 130px;">
                                        <option value="4" selected>4 Sınav</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div id="settings-anadolu-year" class="col-md-6">
                            <label class="fw-bold">Başlangıç Yılı (Anadolu)</label>
                            <select id="startYear" class="form-select">
                                <option value="2024">2024 - 2025</option>
                                <option value="2023">2023 - 2024</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="fw-bold">Sınav Türü</label>
                            <select id="examType" class="form-select">
                                <option value="ara">Ara Sınav (Vize)</option>
                                <option value="final">Final / Dönem Sonu</option>
                                <option value="tek-ders">Tek Ders</option>
                                <option value="yaz-okulu">Yaz Okulu</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-center mt-5">
                        <button class="btn btn-primary btn-lg px-5 fw-bold shadow" id="startBtn">
                            <i class="bi bi-cloud-download"></i> Soruları Getir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="result-panel" class="hidden">
        <div class="row">
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card p-3 sticky-top" style="top: 20px; max-height: 90vh; overflow-y: auto;">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h5 class="fw-bold m-0">Ders Listesi</h5>
                    </div>
                    
                    <div id="sidebar-menu-mistakes" class="mb-3"></div>
                    <hr>
                    <div id="sidebar-menu"></div>
                    
                    <button class="btn btn-danger w-100 mt-4" id="exitBtn">
                        <i class="bi bi-box-arrow-left"></i> Çıkış Yap
                    </button>
                </div>
            </div>

            <div class="col-md-8 col-lg-9">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 id="active-course-title" class="fw-bold text-primary m-0 text-truncate" style="max-width: 60%;">Ders Seçiniz</h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-warning btn-sm" id="resetCourseBtn"><i class="bi bi-arrow-counterclockwise"></i> Sıfırla</button>
                            <span id="question-count" class="badge bg-secondary d-flex align-items-center">0 Soru</span>
                        </div>
                    </div>
                    <hr>
                    <div id="questions-area"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loader" class="loading-overlay hidden">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
    <h3 class="mt-3 fw-bold">Bağlanılıyor...</h3>
    <p id="loader-log" class="text-muted">Lütfen bekleyin...</p>
    <div class="progress w-50 mt-2" style="height: 10px;">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
    </div>
</div>

<script>
(function() {
    // --- GLOBAL DEĞİŞKENLER ---
    var currentUni = 'anadolu';
    var allCoursesData = [];
    var wrongBank = []; 
    var isMistakeView = false;
    var currentCourseIndex = 0;
    
    var PROXIES = [
        "https://api.codetabs.com/v1/proxy?quest=",
        "https://corsproxy.io/?",
        "https://api.allorigins.win/get?url="
    ];

    // --- DOM YÜKLEME ---
    document.addEventListener('DOMContentLoaded', function() {
        // Tema yükle
        if(localStorage.getItem('aof_theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
        }
        updateThemeIcon();

        // Kayıtlı veri yükle
        var savedData = localStorage.getItem('aof_full_data');
        var savedMistakes = localStorage.getItem('aof_wrong_bank');
        
        if(savedData) {
            try { allCoursesData = JSON.parse(savedData); } catch(e) { allCoursesData = []; }
        }
        if(savedMistakes) {
            try { wrongBank = JSON.parse(savedMistakes); } catch(e) { wrongBank = []; }
        }

        if(allCoursesData.length > 0 || wrongBank.length > 0) {
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('result-panel').classList.remove('hidden');
            document.getElementById('globalResetBtn').classList.remove('hidden');
            renderSidebar();
            if(allCoursesData.length > 0) showCourse(0);
            else showMistakes(); 
        }

        // Event Listener'ları bağla
        document.getElementById('tab-anadolu').addEventListener('click', function() { switchUni('anadolu'); });
        document.getElementById('tab-ata').addEventListener('click', function() { switchUni('ata'); });
        document.getElementById('startBtn').addEventListener('click', startProcess);
        document.getElementById('themeBtn').addEventListener('click', toggleTheme);
        document.getElementById('globalResetBtn').addEventListener('click', fullReset);
        document.getElementById('exitBtn').addEventListener('click', fullReset);
        document.getElementById('resetCourseBtn').addEventListener('click', resetCurrentCourse);
    });

    // --- ÜNİVERSİTE DEĞİŞTİR ---
    function switchUni(uni) {
        currentUni = uni;
        var tabs = document.querySelectorAll('.uni-tab');
        for(var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        document.getElementById('tab-' + uni).classList.add('active');
        
        var inputs = document.querySelectorAll('.url-input');
        for(var j = 0; j < inputs.length; j++) {
            inputs[j].value = '';
        }

        if (uni === 'anadolu') {
            document.getElementById('panel-title').innerText = "Anadolu AÖF Sınav Robotu";
            document.getElementById('settings-anadolu-year').classList.remove('hidden');
            document.querySelectorAll('.url-input')[0].placeholder = "https://aofsoru.com/...";
        } else {
            document.getElementById('panel-title').innerText = "ATA AÖF Sınav Robotu";
            document.getElementById('settings-anadolu-year').classList.add('hidden');
            document.querySelectorAll('.url-input')[0].placeholder = "https://ataaofsoru.com/...";
        }
    }

    // --- MOBİL URL TEMİZLE ---
    function cleanMobileUrl(url) {
        return url.replace('/mobile/', '/');
    }

    // --- URL'DEN SLUG ÇIKAR ---
    function extractSlug(url) {
        var cleaned = cleanMobileUrl(url);
        cleaned = cleaned.replace(/https?:\/\//, '').replace('www.', '').replace('aofsoru.com/', '');
        
        var slug = cleaned.split('-sinav-sorulari')[0];
        slug = slug.replace(/-\d{4}-\d{4}-yili.*$/, '');
        
        if (slug.indexOf('-dersi') === -1) {
            slug = slug + '-dersi';
        }
        
        return slug;
    }

    // --- URL FETCH ---
    function fetchUrl(url) {
        return new Promise(function(resolve) {
            var tryProxy = function(index) {
                if(index >= PROXIES.length) {
                    resolve(null);
                    return;
                }
                
                var proxy = PROXIES[index];
                fetch(proxy + encodeURIComponent(url))
                    .then(function(res) {
                        if(!res.ok) {
                            tryProxy(index + 1);
                            return;
                        }
                        if(proxy.indexOf('allorigins') !== -1) {
                            res.json().then(function(json) {
                                if(json.contents) resolve(json.contents);
                                else tryProxy(index + 1);
                            }).catch(function() { tryProxy(index + 1); });
                        } else {
                            res.text().then(function(text) {
                                if(text && text.length > 500) resolve(text);
                                else tryProxy(index + 1);
                            }).catch(function() { tryProxy(index + 1); });
                        }
                    })
                    .catch(function() { tryProxy(index + 1); });
            };
            tryProxy(0);
        });
    }

    // --- ANA İŞLEM BAŞLAT ---
    function startProcess() {
        var tasks = [];
        var rows = document.querySelectorAll('.course-row');
        
        for(var i = 0; i < rows.length; i++) {
            var url = rows[i].querySelector('.url-input').value.trim();
            var limit = parseInt(rows[i].querySelector('.limit-input').value);
            if(url !== "") {
                url = cleanMobileUrl(url);
                tasks.push({ url: url, limit: limit });
            }
        }

        if(tasks.length === 0) { 
            alert("Lütfen en az bir link girin."); 
            return; 
        }

        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('loader').classList.remove('hidden');
        
        var processPromise;
        if (currentUni === 'anadolu') {
            processPromise = processAnadolu(tasks);
        } else {
            processPromise = processAta(tasks);
        }
        
        processPromise.then(function() {
            document.getElementById('loader').classList.add('hidden');

            if(allCoursesData.length > 0) {
                localStorage.setItem('aof_full_data', JSON.stringify(allCoursesData));
                document.getElementById('result-panel').classList.remove('hidden');
                document.getElementById('globalResetBtn').classList.remove('hidden');
                renderSidebar();
                showCourse(0);
            } else {
                alert("Sınav bulunamadı."); 
                location.reload();
            }
        });
    }

    // --- ANADOLU İŞLEME ---
    function processAnadolu(tasks) {
        var startYear = parseInt(document.getElementById('startYear').value);
        var type = document.getElementById('examType').value;
        var minYear = 2012; 
        
        var completed = 0;
        var totalOps = tasks.length * 10; 
        var taskIndex = 0;

        return new Promise(function(resolveAll) {
            function processNextTask() {
                if(taskIndex >= tasks.length) {
                    resolveAll();
                    return;
                }
                
                var task = tasks[taskIndex];
                var slug = extractSlug(task.url);
                
                console.log("İşlenen slug:", slug);
                
                var questionMap = {};
                var examsFound = 0; 
                var currentYear = startYear; 

                function processYear() {
                    if(examsFound >= task.limit || currentYear < minYear) {
                        // Bu ders bitti
                        var questions = [];
                        for(var key in questionMap) {
                            questions.push(questionMap[key]);
                        }
                        if(questions.length > 0) {
                            allCoursesData.push({ 
                                title: slug.replace(/-/g, ' ').toUpperCase(), 
                                questions: questions, 
                                stats: {correct:0, wrong:0} 
                            });
                        }
                        taskIndex++;
                        processNextTask();
                        return;
                    }

                    var nextY = currentYear + 1;
                    completed += 0.5;
                    updateLoader(completed, totalOps, slug + ' | ' + currentYear + '-' + nextY + ' taranıyor... (Bulunan: ' + examsFound + '/' + task.limit + ')');

                    // URL'leri hazırla
                    var urlsToTry = [];
                    
                    if (type === 'ara') {
                        urlsToTry = [
                            'https://aofsoru.com/' + slug + '-' + currentYear + '-' + nextY + '-yili-ara-sinavi-sinav-sorulari'
                        ];
                    } else if (type === 'final') {
                        urlsToTry = [
                            'https://aofsoru.com/' + slug + '-' + currentYear + '-' + nextY + '-yili-donem-sonu-sinavi-sinav-sorulari',
                            'https://aofsoru.com/' + slug + '-' + currentYear + '-' + nextY + '-yili-final-sinavi-sinav-sorulari',
                            'https://aofsoru.com/' + slug + '-' + currentYear + '-' + nextY + '-yili-butunleme-sinavi-sinav-sorulari'
                        ];
                    } else if (type === 'tek-ders') {
                        urlsToTry = [
                            'https://aofsoru.com/' + slug + '-' + currentYear + '-' + nextY + '-yili-tek-ders-sinavi-sinav-sorulari'
                        ];
                    } else if (type === 'yaz-okulu') {
                        urlsToTry = [
                            'https://aofsoru.com/' + slug + '-' + currentYear + '-' + nextY + '-yili-yaz-okulu-sinavi-sinav-sorulari'
                        ];
                    }

                    var urlIndex = 0;
                    var foundThisYear = false;

                    function tryNextUrl() {
                        if(urlIndex >= urlsToTry.length || foundThisYear) {
                            currentYear--;
                            setTimeout(processYear, 100);
                            return;
                        }

                        var genUrl = urlsToTry[urlIndex];
                        console.log("Denenen URL:", genUrl);
                        
                        fetchUrl(genUrl).then(function(html) {
                            if(html) {
                                if (html.indexOf("ARADIĞINIZ SAYFA BULUNAMADI") !== -1 || html.indexOf("404 -") !== -1 || html.indexOf("Sayfa Bulunamadı") !== -1) {
                                    console.log(currentYear + ' boş (404 metni)');
                                } else {
                                    var parser = new DOMParser();
                                    var doc = parser.parseFromString(html, "text/html");
                                    var cards = doc.querySelectorAll('.card');
                                    
                                    if(cards.length > 0) {
                                        var addedCount = 0;
                                        
                                        for(var c = 0; c < cards.length; c++) {
                                            var card = cards[c];
                                            var img = card.querySelector('img.QuestionImg');
                                            var ans = card.getAttribute('data-value') || card.getAttribute('data-cevap');
                                            
                                            if(img) {
                                                var src = img.getAttribute('data-src') || img.getAttribute('src');
                                                if(src) {
                                                    if(src.indexOf('//') === 0) src = 'https:' + src;
                                                    else if(src.indexOf('/') === 0) src = 'https://image.aofsoru.com' + src;
                                                    
                                                    var finalAns = ans ? ans.trim().toUpperCase() : "Bilinmiyor";
                                                    
                                                    var typeLabel = type.toUpperCase();
                                                    if (genUrl.indexOf('donem-sonu') !== -1) typeLabel = 'DÖNEM SONU';
                                                    else if (genUrl.indexOf('final') !== -1) typeLabel = 'FİNAL';
                                                    else if (genUrl.indexOf('butunleme') !== -1) typeLabel = 'BÜTÜNLEME';
                                                    else if (genUrl.indexOf('ara-sinavi') !== -1) typeLabel = 'ARA';
                                                    
                                                    var qObj = { img: src, ans: finalAns, title: currentYear + '-' + nextY + ' ' + typeLabel };
                                                    
                                                    if(!questionMap[src]) {
                                                        questionMap[src] = qObj;
                                                        addedCount++;
                                                    } else if(questionMap[src].ans === "Bilinmiyor" && finalAns !== "Bilinmiyor") {
                                                        questionMap[src] = qObj;
                                                    }
                                                }
                                            }
                                        }
                                        
                                        if (addedCount > 0) {
                                            examsFound++;
                                            foundThisYear = true;
                                            console.log('✓ ' + currentYear + '-' + nextY + ' bulundu! (' + addedCount + ' soru)');
                                        }
                                    }
                                }
                            }
                            
                            urlIndex++;
                            setTimeout(tryNextUrl, 200);
                        });
                    }
                    
                    tryNextUrl();
                }
                
                processYear();
            }
            
            processNextTask();
        });
    }

    // --- ATA İŞLEME ---
    function processAta(tasks) {
        var typeKey = document.getElementById('examType').value;
        if(typeKey === 'donem-sonu') typeKey = 'final';
        
        var totalOps = 0;
        for(var t = 0; t < tasks.length; t++) {
            totalOps += tasks[t].limit;
        }
        var completed = 0;
        var taskIndex = 0;

        return new Promise(function(resolveAll) {
            function processNextTask() {
                if(taskIndex >= tasks.length) {
                    resolveAll();
                    return;
                }
                
                var task = tasks[taskIndex];
                var cleanedUrl = cleanMobileUrl(task.url);
                
                updateLoader(completed, totalOps, 'Ders taranıyor...');
                
                fetchUrl(cleanedUrl).then(function(mainHtml) {
                    if(!mainHtml) {
                        taskIndex++;
                        processNextTask();
                        return;
                    }

                    var parser = new DOMParser();
                    var mainDoc = parser.parseFromString(mainHtml, "text/html");
                    var h1 = mainDoc.querySelector('h1');
                    var title = h1 ? h1.innerText : "ATA Ders";
                    title = title.replace('Soruları', '').trim();

                    var links = [];
                    var allLinks = mainDoc.querySelectorAll('a');
                    
                    for(var a = 0; a < allLinks.length; a++) {
                        var href = allLinks[a].getAttribute('href');
                        var text = (allLinks[a].getAttribute('title') || allLinks[a].innerText || "").toUpperCase();
                        
                        if(text.indexOf('DENEME') !== -1 || text.indexOf('ONLİNE') !== -1 || text.indexOf('TARAMA') !== -1) continue;

                        var keyword = typeKey === 'ara' ? 'ARA' : 'FİNAL';
                        if (keyword === 'FİNAL') { 
                            if (text.indexOf('FİNAL') !== -1 || text.indexOf('BÜTÜNLEME') !== -1 || text.indexOf('DÖNEM SONU') !== -1) keyword = 'MATCH'; 
                        } else {
                            if(text.indexOf('FİNAL') !== -1 || text.indexOf('BÜTÜNLEME') !== -1) continue;
                        }
                        
                        if (href && (text.indexOf(keyword) !== -1 || keyword === 'MATCH')) {
                            var yearMatch = text.match(/(\d{4})\s*-\s*(\d{4})/);
                            var year = yearMatch ? parseInt(yearMatch[1]) : 0;
                            var fullUrl = href.indexOf('http') === 0 ? href : 'https://ataaofsoru.com' + (href.indexOf('/') === 0 ? '' : '/') + href;
                            fullUrl = cleanMobileUrl(fullUrl);
                            links.push({ url: fullUrl, year: year, text: text });
                        }
                    }

                    links.sort(function(a, b) { return b.year - a.year; });

                    var questionMap = {};
                    var examsFound = 0;
                    var linkIndex = 0;

                    function processNextLink() {
                        if(linkIndex >= links.length || examsFound >= task.limit) {
                            var questions = [];
                            for(var key in questionMap) {
                                questions.push(questionMap[key]);
                            }
                            if(questions.length > 0) {
                                allCoursesData.push({ title: title, questions: questions, stats: {correct:0, wrong:0} });
                            }
                            taskIndex++;
                            processNextTask();
                            return;
                        }

                        var link = links[linkIndex];
                        completed += 0.5;
                        updateLoader(completed, totalOps, link.year + ' kontrol ediliyor...');
                        
                        fetchUrl(link.url).then(function(examHtml) {
                            if(examHtml) {
                                var doc = parser.parseFromString(examHtml, "text/html");
                                
                                var pageAnswers = [];
                                var scripts = doc.querySelectorAll('script');
                                for(var s = 0; s < scripts.length; s++) {
                                    var match = scripts[s].innerText.match(/$$
\s*(["'][A-E]["']\s*,?\s*){5,}
$$/g);
                                    if(match) { 
                                        var longest = match[0];
                                        for(var m = 1; m < match.length; m++) {
                                            if(match[m].length > longest.length) longest = match[m];
                                        }
                                        pageAnswers = longest.replace(/[$$

$$"']/g, '').split(','); 
                                        break; 
                                    }
                                }

                                var imgs = doc.querySelectorAll('img.content, img.QuestionImg');
                                var foundAny = false;

                                for(var im = 0; im < imgs.length; im++) {
                                    var img = imgs[im];
                                    var src = img.getAttribute('data-src') || img.getAttribute('src');
                                    if(src) {
                                        if(src.indexOf('//') === 0) src = 'https:' + src;
                                        else if(src.indexOf('http') !== 0) src = 'https://image.ataaofsoru.com' + (src.indexOf('/') === 0 ? '' : '/') + src;
                                        
                                        var ans = "Bilinmiyor";
                                        var parent = img.closest('.card') || img.closest('.row');
                                        if(!parent && img.parentElement) parent = img.parentElement.parentElement;
                                        
                                        if(parent) {
                                            var val = parent.getAttribute('data-value') || parent.getAttribute('data-cevap');
                                            if(val) ans = val;
                                        }
                                        if(ans === "Bilinmiyor" && pageAnswers.length > im) ans = pageAnswers[im].trim();
                                        if(ans === "Bilinmiyor" && parent) {
                                            var successBtn = parent.querySelector('.btn-success');
                                            if(successBtn) ans = successBtn.innerText.trim();
                                        }

                                        var qObj = { img: src, ans: ans.replace(/[^A-E]/g, ''), title: link.text };
                                        questionMap[src] = qObj;
                                        foundAny = true;
                                    }
                                }

                                if(foundAny) examsFound++;
                            }
                            
                            linkIndex++;
                            setTimeout(processNextLink, 400);
                        });
                    }
                    
                    processNextLink();
                });
            }
            
            processNextTask();
        });
    }

    // --- LOADER GÜNCELLE ---
    function updateLoader(val, max, text) {
        var p = Math.min((val / max) * 100, 100);
        document.getElementById('progress-bar').style.width = p + "%";
        document.getElementById('loader-log').innerText = text;
    }

    // --- SIDEBAR OLUŞTUR ---
    function renderSidebar() {
        var menu = document.getElementById('sidebar-menu');
        var mistakemenu = document.getElementById('sidebar-menu-mistakes');
        menu.innerHTML = "";
        mistakemenu.innerHTML = "";

        var mistakeDiv = document.createElement('div');
        mistakeDiv.className = "sidebar-item sidebar-mistakes";
        mistakeDiv.innerHTML = '<i class="bi bi-exclamation-octagon-fill"></i> YANLIŞLARIM <span class="badge bg-danger">' + wrongBank.length + '</span>';
        mistakeDiv.addEventListener('click', function() { showMistakes(); });
        mistakeDiv.id = "menu-item-mistakes";
        mistakemenu.appendChild(mistakeDiv);

        for(var i = 0; i < allCoursesData.length; i++) {
            (function(index) {
                var course = allCoursesData[index];
                var div = document.createElement('div');
                div.className = "sidebar-item";
                div.innerHTML = '<div class="text-truncate" style="max-width: 65%;">' + course.title + '</div>' +
                    '<div class="d-flex gap-1">' +
                    '<span class="badge bg-success stat-badge">' + course.stats.correct + '</span>' +
                    '<span class="badge bg-danger stat-badge">' + course.stats.wrong + '</span>' +
                    '</div>';
                div.addEventListener('click', function() { showCourse(index); });
                div.id = "menu-item-" + index;
                menu.appendChild(div);
            })(i);
        }
    }

    // --- DERS GÖSTER ---
    function showCourse(index) {
        isMistakeView = false;
        currentCourseIndex = index;
        
        var items = document.querySelectorAll('.sidebar-item');
        for(var i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
        }
        document.getElementById("menu-item-" + index).classList.add('active');
        
        var course = allCoursesData[index];
        renderExam(course.title, course.questions);
    }

    // --- YANLIŞLAR GÖSTER ---
    function showMistakes() {
        isMistakeView = true;
        
        var items = document.querySelectorAll('.sidebar-item');
        for(var i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
        }
        document.getElementById("menu-item-mistakes").classList.add('active');
        
        if(wrongBank.length === 0) {
            document.getElementById('active-course-title').innerText = "Yanlışlarım";
            document.getElementById('question-count').innerText = "0 Soru";
            document.getElementById('questions-area').innerHTML = "<div class='text-center py-5 text-muted'><i class='bi bi-emoji-smile fs-1'></i><br>Henüz yanlış yapmadınız!</div>";
        } else {
            renderExam("Yanlış Cevapladığım Sorular", wrongBank);
        }
    }

    // --- SINAV RENDER ---
    function renderExam(title, questions) {
        document.getElementById('active-course-title').innerText = title;
        document.getElementById('question-count').innerText = questions.length + " Soru";
        var area = document.getElementById('questions-area');
        area.innerHTML = "";

        for(var i = 0; i < questions.length; i++) {
            var q = questions[i];
            var questionHtml = '<div class="card mb-5 shadow-sm">' +
                '<div class="card-header d-flex justify-content-between align-items-center">' +
                '<span class="badge bg-secondary text-truncate" style="max-width: 70%">' + q.title + '</span>' +
                '<span class="fw-bold">Soru ' + (i+1) + '</span>' +
                '</div>' +
                '<div class="card-body text-center">' +
                '<div class="p-2 mb-3 border rounded bg-light d-inline-block" style="min-width: 50%;">' +
                '<img src="' + q.img + '" class="question-img" loading="lazy" onerror="this.parentElement.innerHTML=\'<div class=\\\'text-danger py-3\\\'>Resim Yüklenemedi</div>\'">' +
                '</div>' +
                '<div class="mt-2" id="opts-' + i + '">' +
                '<div class="d-flex justify-content-center flex-wrap gap-2">' +
                '<button class="btn btn-circle" data-answer="A" data-correct="' + q.ans + '" data-index="' + i + '">A</button>' +
                '<button class="btn btn-circle" data-answer="B" data-correct="' + q.ans + '" data-index="' + i + '">B</button>' +
                '<button class="btn btn-circle" data-answer="C" data-correct="' + q.ans + '" data-index="' + i + '">C</button>' +
                '<button class="btn btn-circle" data-answer="D" data-correct="' + q.ans + '" data-index="' + i + '">D</button>' +
                '<button class="btn btn-circle" data-answer="E" data-correct="' + q.ans + '" data-index="' + i + '">E</button>' +
                '</div>' +
                '</div>' +
                '<div id="feedback-' + i + '" class="mt-3 fw-bold" style="min-height: 25px;"></div>' +
                '</div>' +
                '</div>';
            area.innerHTML += questionHtml;
        }
        
        area.innerHTML += '<div class="scroll-top-wrapper"><button class="btn btn-outline-primary w-100 py-3" id="scrollTopBtn"><i class="bi bi-arrow-up-circle-fill"></i> Başa Dön</button></div>';
        
        // Cevap butonlarına event listener ekle
        var answerBtns = area.querySelectorAll('.btn-circle');
        for(var j = 0; j < answerBtns.length; j++) {
            answerBtns[j].addEventListener('click', handleAnswerClick);
        }
        
        // Başa dön butonu
        var scrollBtn = document.getElementById('scrollTopBtn');
        if(scrollBtn) {
            scrollBtn.addEventListener('click', function() {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- CEVAP KONTROL ---
    function handleAnswerClick(e) {
        var btn = e.target;
        var selected = btn.getAttribute('data-answer');
        var correct = btn.getAttribute('data-correct');
        var qIdx = parseInt(btn.getAttribute('data-index'));
        
        var container = document.getElementById("opts-" + qIdx);
        var feedback = document.getElementById("feedback-" + qIdx);
        var buttons = container.querySelectorAll('button');
        
        for(var i = 0; i < buttons.length; i++) {
            buttons[i].disabled = true;
        }

        if(!correct || correct === "Bilinmiyor") {
            btn.style.backgroundColor = "#ffc107";
            feedback.innerHTML = "<span class='text-warning'>Cevap Gizli</span>"; 
            return;
        }

        var isCorrect = (selected === correct);

        if(isCorrect) {
            btn.classList.add('correct-green');
            feedback.innerHTML = "<span class='text-success'>DOĞRU!</span>";
            if(!isMistakeView) allCoursesData[currentCourseIndex].stats.correct++;
        } else {
            btn.classList.add('wrong-red');
            feedback.innerHTML = "<span class='text-danger'>YANLIŞ! Doğru: " + correct + "</span>";
            
            for(var j = 0; j < buttons.length; j++) {
                if(buttons[j].innerText === correct) {
                    buttons[j].classList.add('correct-green');
                }
            }
            
            if(!isMistakeView) {
                allCoursesData[currentCourseIndex].stats.wrong++;
                var currentQ = allCoursesData[currentCourseIndex].questions[qIdx];
                var exists = false;
                for(var k = 0; k < wrongBank.length; k++) {
                    if(wrongBank[k].img === currentQ.img) {
                        exists = true;
                        break;
                    }
                }
                if(!exists) {
                    wrongBank.push(currentQ);
                    localStorage.setItem('aof_wrong_bank', JSON.stringify(wrongBank));
                }
            }
        }
        renderSidebar();
        localStorage.setItem('aof_full_data', JSON.stringify(allCoursesData));
    }

    // --- DERS SIFIRLA ---
    function resetCurrentCourse() {
        var msg = isMistakeView ? "Yanlışlar kasası temizlensin mi?" : "Bu dersteki cevaplar silinecek?";
        if(!confirm(msg)) return;
        
        if(isMistakeView) {
            wrongBank = []; 
            localStorage.removeItem('aof_wrong_bank'); 
            showMistakes();
        } else {
            allCoursesData[currentCourseIndex].stats.correct = 0;
            allCoursesData[currentCourseIndex].stats.wrong = 0;
            showCourse(currentCourseIndex);
        }
        renderSidebar();
        localStorage.setItem('aof_full_data', JSON.stringify(allCoursesData));
    }

    // --- TAM SIFIRLA ---
    function fullReset() {
        if(!confirm("Her şey silinecek?")) return;
        localStorage.clear(); 
        location.reload();
    }
    
    // --- TEMA DEĞİŞTİR ---
    function toggleTheme() {
        var body = document.body;
        if(body.getAttribute('data-theme') === 'dark') { 
            body.removeAttribute('data-theme'); 
            localStorage.setItem('aof_theme', 'light'); 
        } else { 
            body.setAttribute('data-theme', 'dark'); 
            localStorage.setItem('aof_theme', 'dark'); 
        }
        updateThemeIcon();
    }
    
    // --- TEMA İKON GÜNCELLE ---
    function updateThemeIcon() { 
        var icon = document.getElementById('themeIcon');
        if(icon) {
            icon.className = document.body.getAttribute('data-theme') === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill'; 
        }
    }

})();
</script>

</body>
</html>
