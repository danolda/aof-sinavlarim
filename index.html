<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AÖF Sınav Robotu (v6 - Kesin Yıl Çözümü)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { background-color: #eef2f7; font-family: 'Segoe UI', sans-serif; }
        .hidden { display: none !important; }
        
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        .question-img { 
            max-width: 100%; 
            border: 1px solid #dfe3e8; 
            border-radius: 8px; 
            margin: 15px 0;
            background: white;
            min-height: 150px;
        }
        
        /* Büyük Şık Butonları */
        .btn-circle { 
            width: 60px; height: 60px; border-radius: 50%; padding: 0; 
            font-size: 1.4rem; font-weight: bold; margin: 0 8px; 
            border: 2px solid #6c757d; color: #6c757d; background: white; 
            transition: transform 0.2s, background 0.2s;
        }
        .btn-circle:hover { background-color: #6c757d; color: white; transform: translateY(-3px); }
        .btn-circle:active { transform: scale(0.95); }

        .correct-green { background-color: #198754 !important; color: white !important; border-color: #198754 !important; }
        .wrong-red { background-color: #dc3545 !important; color: white !important; border-color: #dc3545 !important; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div class="container py-5">
    
    <!-- 1. GİRİŞ PANELİ -->
    <div id="setup-panel" class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-5 shadow">
                <div class="text-center mb-4">
                    <h2 class="fw-bold text-primary">AÖF Sınav Hazırlayıcı</h2>
                    <p class="text-muted">Doğru yıl sıralaması ve akıllı soru çekimi.</p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold">Ders Linki</label>
                    <input type="text" class="form-control form-control-lg url-input" placeholder="https://aofsoru.com/..." >
                    <div class="form-text">Dersin ana sayfa linkini yapıştırın.</div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Soru Arşivi</label>
                        <select id="yearLimit" class="form-select form-select-lg">
                            <option value="4" selected>Son 4 Sınav (Otomatik)</option>
                            <option value="5">Son 5 Sınav</option>
                            <option value="10">Mevcut Tümü</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Sınav Türü</label>
                        <select id="examType" class="form-select form-select-lg">
                            <option value="vize">Ara Sınav (Vize)</option>
                            <option value="final">Dönem Sonu (Final)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary w-100 btn-lg mt-5 py-3 fw-bold" onclick="startProcess()">
                    <i class="material-icons align-middle">search</i> Sınavları Getir
                </button>
            </div>
        </div>
    </div>

    <!-- 2. LİSTE PANELİ -->
    <div id="course-panel" class="hidden">
        <h3 class="text-center mb-4">Hazır Sınavlar</h3>
        <div id="course-list" class="d-grid gap-3 col-lg-8 mx-auto"></div>
        <div class="text-center mt-4">
            <button class="btn btn-outline-secondary" onclick="location.reload()">Yeni Arama</button>
        </div>
    </div>

    <!-- 3. SORU PANELİ -->
    <div id="quiz-panel" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white p-3 shadow-sm rounded z-3">
            <h5 id="currentCourseTitle" class="m-0 text-truncate text-primary fw-bold" style="max-width: 70%;">Ders Adı</h5>
            <button class="btn btn-danger btn-sm" onclick="switchPanel('course-panel')">Kapat</button>
        </div>
        
        <div id="questions-container" class="col-lg-8 mx-auto pb-5"></div>
        
        <div class="fixed-bottom bg-white border-top p-3 text-center shadow-lg">
            <button class="btn btn-success px-5 fw-bold" onclick="switchPanel('course-panel')">Listeye Dön</button>
        </div>
    </div>

</div>

<!-- LOADING -->
<div id="loading" class="loading-overlay hidden">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="mt-3">İşleniyor...</h4>
    <p id="loadingLog" class="text-muted small">Başlatılıyor</p>
</div>

<script>
    const BASE_URL = "https://aofsoru.com";
    let examData = [];

    // Proxy Listesi (Yedekli)
    const PROXIES = [
        { url: "https://api.codetabs.com/v1/proxy?quest=", type: "text" }, 
        { url: "https://api.allorigins.win/get?url=", type: "json" },
        { url: "https://corsproxy.io/?", type: "text" }
    ];

    async function fetchWithFallback(targetUrl) {
        for (let i = 0; i < PROXIES.length; i++) {
            const proxy = PROXIES[i];
            const fullUrl = proxy.url + encodeURIComponent(targetUrl);
            updateLog(`Sunucu deneniyor (${i+1}/${PROXIES.length})...`);
            
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) throw new Error("Proxy hatası");
                
                let htmlContent = "";
                if (proxy.type === "json") {
                    const data = await response.json();
                    htmlContent = data.contents;
                } else {
                    htmlContent = await response.text();
                }

                if (!htmlContent || htmlContent.length < 500) throw new Error("Boş veri");
                return htmlContent;

            } catch (error) { console.warn("Proxy Error:", error); }
        }
        return null;
    }

    function parseHtml(htmlString) {
        return new DOMParser().parseFromString(htmlString, "text/html");
    }

    async function startProcess() {
        const url = document.querySelector('.url-input').value.trim();
        const yearLimit = parseInt(document.getElementById('yearLimit').value);
        const examType = document.getElementById('examType').value;

        if (!url) { alert("Lütfen link girin."); return; }
        
        showLoading(true);
        examData = [];

        let targetUrl = url.startsWith('http') ? url : 'https://' + url;
        
        updateLog("Ders sayfası taranıyor...");
        const courseHtml = await fetchWithFallback(targetUrl);
        
        if (!courseHtml) {
            alert("Siteye erişilemedi. Güvenlik duvarı engelliyor olabilir.");
            showLoading(false);
            return;
        }

        const doc = parseHtml(courseHtml);
        let title = doc.querySelector('h1')?.innerText.replace('Soruları', '').trim() || "Ders";
        
        // --- YENİ YIL MANTIĞI ---
        updateLog("Sınavlar tarihe göre sıralanıyor...");
        const links = getExamLinks(doc, examType, yearLimit);

        if (links.length > 0) {
            updateLog(`${links.length} sınav bulundu. Sorular çekiliyor...`);
            const questions = await scrapeQuestionsFromLinks(links);
            if (questions.length > 0) {
                examData.push({ title, questions });
                renderCourses();
                switchPanel('course-panel');
            } else {
                alert("Sorular çekilemedi. Site yapısı uyumsuz.");
            }
        } else {
            alert("Bu kriterlere uygun sınav bulunamadı.");
        }
        showLoading(false);
    }

    // --- YIL MANTIĞI DÜZELTME (KESİN ÇÖZÜM) ---
    function getExamLinks(doc, type, limit) {
        const targetText = type === "vize" ? "ARA" : "DÖNEM SONU";
        let validLinks = [];
        
        const allLinks = doc.querySelectorAll('a');
        allLinks.forEach(link => {
            const title = (link.getAttribute('title') || "").toUpperCase();
            const href = link.getAttribute('href');
            
            if (title.includes(targetText) && href) {
                // Linkteki ilk 4 haneli sayıyı (Yılı) bul. Örn: 2024
                const yearMatch = title.match(/(\d{4})/);
                let year = yearMatch ? parseInt(yearMatch[0]) : 0;
                
                let fullUrl = href.startsWith('http') ? href : BASE_URL + (href.startsWith('/') ? '' : '/') + href;
                
                validLinks.push({ url: fullUrl, year, title });
            }
        });
        
        // 1. Önce Yıla Göre Sırala (Büyükten Küçüğe)
        // Böylece liste: [2024, 2023, 2022, 2021...] şeklinde olur.
        validLinks.sort((a, b) => b.year - a.year);
        
        // 2. Tekrarlanan linkleri temizle
        const uniqueLinks = [];
        const seenUrls = new Set();
        for (const item of validLinks) {
            if (!seenUrls.has(item.url)) {
                seenUrls.add(item.url);
                uniqueLinks.push(item);
            }
        }

        // 3. Kullanıcının istediği kadarını (Limit) EN ÜSTTEN al.
        // Bu sayede eğer 2025 yoksa, otomatik olarak 2024'ten başlar ve geriye doğru 4 tane alır.
        return uniqueLinks.slice(0, limit);
    }

    // --- GELİŞMİŞ CEVAP TARAMA ---
    async function scrapeQuestionsFromLinks(links) {
        let allQuestions = [];
        
        for (let link of links) {
            updateLog(`İşleniyor: ${link.year} - ${link.title}`);
            await new Promise(r => setTimeout(r, 800)); 
            
            const html = await fetchWithFallback(link.url);
            if (!html) continue;

            const doc = parseHtml(html);
            
            // CEVAP BULMA SİMÜLASYONU
            let foundAnswers = [];
            
            // Yöntem 1: Script içindeki dizileri tara (En yaygın yöntem)
            // ["A", "B", "E", "C"...] gibi yapıları arar.
            const scriptContent = Array.from(doc.querySelectorAll('script')).map(s => s.innerText).join(' ');
            const arrayMatch = scriptContent.match(/\[\s*(["'][A-E]["']\s*,?\s*){5,}\]/g);
            
            if (arrayMatch) {
                // En uzun diziyi al (Genelde en uzun dizi cevap anahtarıdır)
                const bestMatch = arrayMatch.reduce((a, b) => a.length > b.length ? a : b);
                foundAnswers = bestMatch.replace(/[\[\]"']/g, '').split(',').map(s => s.trim());
            } 
            
            // Yöntem 2: "Cevap: A" regexi
            if (foundAnswers.length === 0) {
                 const regex = /["']?Cevap["']?\s*[:=]\s*["']([A-E])["']/gi;
                 let m;
                 while ((m = regex.exec(html)) !== null) {
                     foundAnswers.push(m[1]);
                 }
            }

            const imgs = doc.querySelectorAll('img.QuestionImg');
            imgs.forEach((img, index) => {
                let src = img.getAttribute('data-src') || img.getAttribute('src');
                if (src) {
                    src = src.trim();
                    if (src.startsWith('//')) src = 'https:' + src;
                    else if (src.startsWith('/')) src = 'https://image.aofsoru.com' + src;
                    else if (!src.startsWith('http')) src = BASE_URL + '/' + src;

                    let correctAnswer = "Bilinmiyor";
                    if (foundAnswers.length > index) {
                        correctAnswer = foundAnswers[index].toUpperCase();
                    }

                    allQuestions.push({
                        image: src,
                        answer: correctAnswer,
                        info: `${link.year} - ${link.title}`
                    });
                }
            });
        }
        return allQuestions;
    }

    // --- UI FONKSİYONLARI ---
    function renderCourses() {
        const list = document.getElementById('course-list');
        list.innerHTML = "";
        examData.forEach((course, index) => {
            list.innerHTML += `
                <div class="card p-4 shadow-sm" onclick="startQuiz(${index})" style="cursor:pointer; border-left:6px solid #0d6efd">
                    <h5 class="m-0 fw-bold">${course.title}</h5>
                    <small class="text-muted">${course.questions.length} Soru Hazır</small>
                </div>`;
        });
    }

    function startQuiz(index) {
        const course = examData[index];
        document.getElementById('currentCourseTitle').innerText = course.title;
        const container = document.getElementById('questions-container');
        container.innerHTML = "";

        course.questions.forEach((q, i) => {
            container.innerHTML += `
                <div class="card mb-5">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <span class="badge bg-dark">Soru ${i+1}</span>
                        <small class="text-muted fw-bold">${q.info}</small>
                    </div>
                    <div class="card-body text-center p-0">
                        <div class="bg-light p-3">
                            <img src="${q.image}" class="question-img shadow-sm" 
                                 onerror="this.parentElement.innerHTML='<div class=\'alert alert-danger\'>Resim Yüklenemedi</div>'">
                        </div>
                        <div class="py-4 px-2" id="opts-${i}">
                            <div class="d-flex justify-content-center flex-wrap gap-2">
                                ${['A','B','C','D','E'].map(opt => 
                                    `<button class="btn btn-circle" onclick="check(this, '${opt}', '${q.answer}', ${i})">${opt}</button>`
                                ).join('')}
                            </div>
                        </div>
                        <div id="fb-${i}" class="pb-3 fw-bold" style="min-height:40px"></div>
                    </div>
                </div>`;
        });
        switchPanel('quiz-panel');
        window.scrollTo(0,0);
    }

    window.check = function(btn, selected, correct, id) {
        const parent = document.getElementById(`opts-${id}`);
        const fb = document.getElementById(`fb-${id}`);
        parent.querySelectorAll('button').forEach(b => b.disabled = true);

        if (correct === "Bilinmiyor") {
            fb.innerHTML = "<span class='badge bg-warning text-dark'>Cevap Anahtarı Gizli (Site Koruması)</span>";
            return;
        }

        if (selected === correct) {
            btn.classList.add('correct-green');
            fb.innerHTML = "<span class='badge bg-success p-2 fs-6'>DOĞRU!</span>";
        } else {
            btn.classList.add('wrong-red');
            fb.innerHTML = `<span class='badge bg-danger p-2 fs-6'>YANLIŞ! Doğru: ${correct}</span>`;
            Array.from(parent.children).forEach(b => {
                if(b.innerText.trim() === correct) b.classList.add('correct-green');
            });
        }
    }

    function switchPanel(id) {
        ['setup-panel','course-panel','quiz-panel'].forEach(p => document.getElementById(p).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
    function updateLog(msg) { document.getElementById('loadingLog').innerText = msg; }
</script>

</body>
</html>
